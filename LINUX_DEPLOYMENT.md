# Linux RayÈõÜÁæ§ÈÉ®ÁΩ≤ÊåáÂçó

## üêß Â∞ÜÂàÜÂ∏ÉÂºèÊñá‰ª∂‰º†ËæìÁ≥ªÁªüÊï¥ÂêàÂà∞Linux RayÈõÜÁæ§

### 1. Á≥ªÁªüË¶ÅÊ±Ç

#### ÁéØÂ¢ÉË¶ÅÊ±Ç
- LinuxÁ≥ªÁªü (Ubuntu 18.04+ / CentOS 7+ / RHEL 7+)
- Python 3.8+ (Âª∫ËÆÆ3.10+)
- Â∑≤ËøêË°åÁöÑRayÈõÜÁæ§
- ÁΩëÁªúËøûÈÄöÊÄß (UDPÁ´ØÂè£ËåÉÂõ¥Ôºö9000-9999)

#### ‰æùËµñÂåÖ
```bash
# Ê†∏ÂøÉ‰æùËµñ
pip install ray==2.48.0 fastapi==0.116.1 uvicorn[standard] pydantic requests websockets

# ÂèØÈÄâ‰æùËµñ
pip install psutil aiofiles python-multipart
```

### 2. Êñá‰ª∂ÈÉ®ÁΩ≤

#### 2.1 ÂàõÂª∫È°πÁõÆÁõÆÂΩï
```bash
# Âú®RayÈõÜÁæ§ÁöÑÂ∑•‰ΩúËäÇÁÇπ‰∏äÂàõÂª∫È°πÁõÆÁõÆÂΩï
mkdir -p /opt/castray-system
cd /opt/castray-system

# ÂàõÂª∫ÂøÖË¶ÅÁöÑÂ≠êÁõÆÂΩï
mkdir -p {downloads,demo_files,static,logs}
chmod 755 downloads demo_files static logs
```

#### 2.2 ‰∏ä‰º†È°πÁõÆÊñá‰ª∂
Â∞Ü‰ª•‰∏ãÊñá‰ª∂‰∏ä‰º†Âà∞LinuxÁ≥ªÁªüÔºö
```
/opt/castray-system/
‚îú‚îÄ‚îÄ main.py                 # FastAPI WebÊúçÂä°Âô®
‚îú‚îÄ‚îÄ ray_casting.py          # RayËäÇÁÇπÁÆ°ÁêÜ
‚îú‚îÄ‚îÄ file_transfer.py        # Êñá‰ª∂‰º†ËæìÂçèËÆÆ
‚îú‚îÄ‚îÄ models.py              # Êï∞ÊçÆÊ®°Âûã
‚îú‚îÄ‚îÄ config.json            # ÈÖçÁΩÆÊñá‰ª∂
‚îú‚îÄ‚îÄ requirements.txt       # ‰æùËµñÊ∏ÖÂçï
‚îú‚îÄ‚îÄ deploy_scripts/        # ÈÉ®ÁΩ≤ËÑöÊú¨
‚îÇ   ‚îú‚îÄ‚îÄ install.sh
‚îÇ   ‚îú‚îÄ‚îÄ start_service.sh
‚îÇ   ‚îî‚îÄ‚îÄ systemd_service.conf
‚îî‚îÄ‚îÄ logs/                  # Êó•ÂøóÁõÆÂΩï
```

### 3. ÈÖçÁΩÆÊñá‰ª∂Ë∞ÉÊï¥

#### 3.1 ÂàõÂª∫LinuxÈÖçÁΩÆÊñá‰ª∂
```bash
cat > /opt/castray-system/config_linux.json << 'EOF'
{
    "ray_cluster": {
        "address": "auto",
        "namespace": "castray",
        "runtime_env": {
            "working_dir": "/opt/castray-system"
        }
    },
    "web_server": {
        "host": "0.0.0.0",
        "port": 8000,
        "log_level": "info"
    },
    "file_transfer": {
        "chunk_size": 65536,
        "max_file_size": "1GB",
        "timeout": 300,
        "download_dir": "/opt/castray-system/downloads"
    },
    "networking": {
        "udp_port_range": [9000, 9999],
        "multicast_group": "224.1.1.1",
        "multicast_port": 9999
    },
    "logging": {
        "level": "INFO",
        "file": "/opt/castray-system/logs/castray.log",
        "max_size": "100MB",
        "backup_count": 5
    }
}
EOF
```

#### 3.2 ‰øÆÊîπmain.py‰ª•ÊîØÊåÅLinuxÈÖçÁΩÆ
ÈúÄË¶ÅÊõ¥Êñ∞main.py‰ª•ËØªÂèñLinuxÈÖçÁΩÆÔºö

```python
# Âú®main.pyÂºÄÂ§¥Ê∑ªÂä†ÈÖçÁΩÆÂä†ËΩΩ
import json
import platform
from pathlib import Path

# Âä†ËΩΩÈÖçÁΩÆ
def load_config():
    if platform.system() == "Linux":
        config_file = Path("/opt/castray-system/config_linux.json")
    else:
        config_file = Path("config.json")
    
    if config_file.exists():
        with open(config_file, 'r') as f:
            return json.load(f)
    return {}

config = load_config()
```

### 4. ËøûÊé•Âà∞Â∑≤ÊúâRayÈõÜÁæ§

#### 4.1 Ëá™Âä®ÂèëÁé∞RayÈõÜÁæ§
```python
# Âú®ray_casting.py‰∏≠‰øÆÊîπËøûÊé•ÈÄªËæë
import ray
import os

async def connect_to_existing_cluster():
    """ËøûÊé•Âà∞Â∑≤ÊúâÁöÑRayÈõÜÁæ§"""
    try:
        # ÊñπÊ≥ï1: ‰ΩøÁî®ÁéØÂ¢ÉÂèòÈáè
        ray_address = os.environ.get('RAY_ADDRESS')
        if ray_address:
            ray.init(address=ray_address)
            logger.info(f"Â∑≤ËøûÊé•Âà∞RayÈõÜÁæ§: {ray_address}")
            return True
        
        # ÊñπÊ≥ï2: Ëá™Âä®ÂèëÁé∞Êú¨Âú∞ÈõÜÁæ§
        ray.init(address='auto')
        logger.info("Â∑≤ËøûÊé•Âà∞Êú¨Âú∞RayÈõÜÁæ§")
        return True
        
    except Exception as e:
        logger.error(f"ËøûÊé•RayÈõÜÁæ§Â§±Ë¥•: {e}")
        return False
```

#### 4.2 ËÆæÁΩÆRayËøêË°åÊó∂ÁéØÂ¢É
```python
# ÈÖçÁΩÆRayËøêË°åÊó∂ÁéØÂ¢É
runtime_env = {
    "working_dir": "/opt/castray-system",
    "pip": [
        "fastapi==0.116.1",
        "uvicorn[standard]",
        "pydantic",
        "requests"
    ],
    "env_vars": {
        "PYTHONPATH": "/opt/castray-system",
        "CASTRAY_CONFIG": "/opt/castray-system/config_linux.json"
    }
}

ray.init(
    address=ray_address,
    runtime_env=runtime_env,
    namespace="castray"
)
```

### 5. ÈÉ®ÁΩ≤ËÑöÊú¨

#### 5.1 ÂÆâË£ÖËÑöÊú¨ (install.sh)
```bash
#!/bin/bash

cat > /opt/castray-system/deploy_scripts/install.sh << 'EOF'
#!/bin/bash
set -e

echo "üöÄ ÂºÄÂßãÈÉ®ÁΩ≤CastRayÊñá‰ª∂‰º†ËæìÁ≥ªÁªüÂà∞Linux RayÈõÜÁæ§"

# Ê£ÄÊü•ÊòØÂê¶‰ª•rootÊùÉÈôêËøêË°å
if [[ $EUID -ne 0 ]]; then
   echo "‚ùå ËØ∑‰ª•rootÊùÉÈôêËøêË°åÊ≠§ËÑöÊú¨"
   exit 1
fi

# Ê£ÄÊü•PythonÁâàÊú¨
python_version=$(python3 --version 2>&1 | grep -oP '\d+\.\d+' | head -1)
required_version="3.8"

if [ "$(printf '%s\n' "$required_version" "$python_version" | sort -V | head -n1)" != "$required_version" ]; then
    echo "‚ùå PythonÁâàÊú¨Ëøá‰ΩéÔºåÈúÄË¶Å3.8+ÔºåÂΩìÂâçÁâàÊú¨: $python_version"
    exit 1
fi

echo "‚úÖ PythonÁâàÊú¨Ê£ÄÊü•ÈÄöËøá: $python_version"

# ÂàõÂª∫Á≥ªÁªüÁî®Êà∑
if ! id "castray" &>/dev/null; then
    useradd -r -d /opt/castray-system -s /bin/bash castray
    echo "‚úÖ ÂàõÂª∫Á≥ªÁªüÁî®Êà∑: castray"
fi

# ËÆæÁΩÆÁõÆÂΩïÊùÉÈôê
chown -R castray:castray /opt/castray-system
chmod 755 /opt/castray-system
chmod -R 755 /opt/castray-system/deploy_scripts

# ÂÆâË£ÖPython‰æùËµñ
echo "üì¶ ÂÆâË£ÖPython‰æùËµñ..."
sudo -u castray python3 -m pip install --user -r /opt/castray-system/requirements.txt

# Ê£ÄÊü•RayÈõÜÁæ§ËøûÊé•
echo "üîç Ê£ÄÊü•RayÈõÜÁæ§Áä∂ÊÄÅ..."
if ray status 2>/dev/null; then
    echo "‚úÖ RayÈõÜÁæ§ËøêË°åÊ≠£Â∏∏"
else
    echo "‚ö†Ô∏è  Êú™Ê£ÄÊµãÂà∞ËøêË°å‰∏≠ÁöÑRayÈõÜÁæ§ÔºåËØ∑Á°Æ‰øùRayÈõÜÁæ§Â∑≤ÂêØÂä®"
fi

# ÂàõÂª∫systemdÊúçÂä°
cp /opt/castray-system/deploy_scripts/systemd_service.conf /etc/systemd/system/castray.service
systemctl daemon-reload
systemctl enable castray

echo "‚úÖ CastRayÁ≥ªÁªüÂÆâË£ÖÂÆåÊàê"
echo "üí° ‰ΩøÁî®‰ª•‰∏ãÂëΩ‰ª§ÂêØÂä®ÊúçÂä°:"
echo "   systemctl start castray"
echo "   systemctl status castray"
EOF

chmod +x /opt/castray-system/deploy_scripts/install.sh
```

#### 5.2 ÂêØÂä®ËÑöÊú¨ (start_service.sh)
```bash
cat > /opt/castray-system/deploy_scripts/start_service.sh << 'EOF'
#!/bin/bash

cd /opt/castray-system

# ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáè
export RAY_ADDRESS=${RAY_ADDRESS:-auto}
export PYTHONPATH=/opt/castray-system:$PYTHONPATH
export CASTRAY_CONFIG=/opt/castray-system/config_linux.json

# Ê£ÄÊü•RayÈõÜÁæ§Áä∂ÊÄÅ
echo "üîç Ê£ÄÊü•RayÈõÜÁæ§ËøûÊé•..."
if ! ray status &>/dev/null; then
    echo "‚ùå Êó†Ê≥ïËøûÊé•Âà∞RayÈõÜÁæ§ÔºåËØ∑Ê£ÄÊü•RayÈõÜÁæ§Áä∂ÊÄÅ"
    exit 1
fi

echo "‚úÖ RayÈõÜÁæ§ËøûÊé•Ê≠£Â∏∏"

# ÂêØÂä®CastRayÊúçÂä°
echo "üöÄ ÂêØÂä®CastRayÊñá‰ª∂‰º†ËæìÁ≥ªÁªü..."
exec python3 main.py
EOF

chmod +x /opt/castray-system/deploy_scripts/start_service.sh
```

#### 5.3 systemdÊúçÂä°ÈÖçÁΩÆ
```bash
cat > /opt/castray-system/deploy_scripts/systemd_service.conf << 'EOF'
[Unit]
Description=CastRay Distributed File Transfer System
After=network.target
Requires=network.target

[Service]
Type=simple
User=castray
Group=castray
WorkingDirectory=/opt/castray-system
ExecStart=/opt/castray-system/deploy_scripts/start_service.sh
Restart=always
RestartSec=10
Environment=RAY_ADDRESS=auto
Environment=PYTHONPATH=/opt/castray-system
Environment=CASTRAY_CONFIG=/opt/castray-system/config_linux.json

# Êó•ÂøóÈÖçÁΩÆ
StandardOutput=journal
StandardError=journal
SyslogIdentifier=castray

# ÂÆâÂÖ®ÈÖçÁΩÆ
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ReadWritePaths=/opt/castray-system

[Install]
WantedBy=multi-user.target
EOF
```

### 6. ÁΩëÁªúÈÖçÁΩÆ

#### 6.1 Èò≤ÁÅ´Â¢ôÈÖçÁΩÆ
```bash
# Ubuntu/Debian
sudo ufw allow 8000/tcp comment "CastRay Web Interface"
sudo ufw allow 9000:9999/udp comment "CastRay File Transfer"

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=8000/tcp
sudo firewall-cmd --permanent --add-port=9000-9999/udp
sudo firewall-cmd --reload
```

#### 6.2 SELinuxÈÖçÁΩÆ (CentOS/RHEL)
```bash
# Â¶ÇÊûúÂêØÁî®‰∫ÜSELinux
sudo setsebool -P httpd_can_network_connect 1
sudo semanage port -a -t http_port_t -p tcp 8000 2>/dev/null || true
```

### 7. ÈÉ®ÁΩ≤ÊµÅÁ®ã

#### 7.1 ÂáÜÂ§áÂ∑•‰Ωú
```bash
# 1. Á°Æ‰øùRayÈõÜÁæ§ËøêË°å
ray status

# 2. ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáè
export RAY_ADDRESS=$(ray status | grep "Ray runtime started" -A 1 | tail -1 | awk '{print $NF}')
echo "RayÈõÜÁæ§Âú∞ÂùÄ: $RAY_ADDRESS"
```

#### 7.2 ÊâßË°åÈÉ®ÁΩ≤
```bash
# 1. ÂàõÂª∫È°πÁõÆÁõÆÂΩï
sudo mkdir -p /opt/castray-system
cd /opt/castray-system

# 2. ‰∏ä‰º†Êñá‰ª∂ (‰ΩøÁî®scpÊàñÂÖ∂‰ªñÊñπÂºè)
# scp -r ./CastRay/* user@linux-server:/opt/castray-system/

# 3. ËøêË°åÂÆâË£ÖËÑöÊú¨
sudo ./deploy_scripts/install.sh

# 4. ÂêØÂä®ÊúçÂä°
sudo systemctl start castray
sudo systemctl status castray
```

### 8. È™åËØÅÈÉ®ÁΩ≤

#### 8.1 Ê£ÄÊü•ÊúçÂä°Áä∂ÊÄÅ
```bash
# Ê£ÄÊü•Á≥ªÁªüÊúçÂä°
systemctl status castray

# Ê£ÄÊü•Êó•Âøó
journalctl -u castray -f

# Ê£ÄÊü•ËøõÁ®ã
ps aux | grep python3.*main.py

# Ê£ÄÊü•Á´ØÂè£
netstat -tulpn | grep :8000
```

#### 8.2 ÊµãËØïÂäüËÉΩ
```bash
# ÊµãËØïWebÊé•Âè£
curl http://localhost:8000/api/status

# ÊµãËØïËäÇÁÇπÂàõÂª∫
curl -X POST http://localhost:8000/api/nodes \
  -H "Content-Type: application/json" \
  -d '{"node_id": "test_node", "port": 9001}'

# Êü•ÁúãRayÈõÜÁæ§‰∏≠ÁöÑCastRay actors
ray list actors --filter="class_name=CastingNode"
```

### 9. ÁõëÊéßÂíåÁª¥Êä§

#### 9.1 Êó•ÂøóÁõëÊéß
```bash
# Êü•ÁúãÂ∫îÁî®Êó•Âøó
tail -f /opt/castray-system/logs/castray.log

# Êü•ÁúãÁ≥ªÁªüÊó•Âøó
journalctl -u castray -f

# Êó•ÂøóËΩÆËΩ¨ÈÖçÁΩÆ
cat > /etc/logrotate.d/castray << 'EOF'
/opt/castray-system/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 castray castray
    postrotate
        systemctl reload castray
    endscript
}
EOF
```

#### 9.2 ÊÄßËÉΩÁõëÊéß
```bash
# ÁõëÊéßËÑöÊú¨
cat > /opt/castray-system/monitor.sh << 'EOF'
#!/bin/bash
echo "=== CastRayÁ≥ªÁªüÁä∂ÊÄÅ ==="
echo "ÊúçÂä°Áä∂ÊÄÅ: $(systemctl is-active castray)"
echo "RayÈõÜÁæ§: $(ray status --address=auto 2>/dev/null | grep -o 'ALIVE\|DEAD' | head -1)"
echo "WebÊé•Âè£: $(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/api/status)"
echo "Ê¥ªË∑ÉËäÇÁÇπ: $(curl -s http://localhost:8000/api/status | jq -r '.active_nodes // "N/A"')"
echo "Êñá‰ª∂‰º†Ëæì: $(curl -s http://localhost:8000/api/file-transfers/status | jq -r 'length')"
EOF

chmod +x /opt/castray-system/monitor.sh
```

### 10. È´òÂèØÁî®ÊÄßÈÖçÁΩÆ

#### 10.1 Ë¥üËΩΩÂùáË°°ÈÖçÁΩÆ (Nginx)
```nginx
upstream castray_backend {
    server 192.168.1.10:8000;
    server 192.168.1.11:8000;
    server 192.168.1.12:8000;
}

server {
    listen 80;
    server_name castray.yourdomain.com;
    
    location / {
        proxy_pass http://castray_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    location /ws {
        proxy_pass http://castray_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }
}
```

### 11. ÊïÖÈöúÊéíÈô§

#### Â∏∏ËßÅÈóÆÈ¢òÂèäËß£ÂÜ≥ÊñπÊ°à

1. **RayËøûÊé•Â§±Ë¥•**
   ```bash
   # Ê£ÄÊü•RayÁä∂ÊÄÅ
   ray status
   
   # ÈáçÂêØRayÈõÜÁæ§
   ray stop
   ray start --head --dashboard-host=0.0.0.0
   ```

2. **Á´ØÂè£Âç†Áî®**
   ```bash
   # Êü•ÊâæÂç†Áî®8000Á´ØÂè£ÁöÑËøõÁ®ã
   sudo lsof -i :8000
   
   # ‰øÆÊîπÈÖçÁΩÆ‰ΩøÁî®ÂÖ∂‰ªñÁ´ØÂè£
   sed -i 's/"port": 8000/"port": 8080/' /opt/castray-system/config_linux.json
   ```

3. **ÊùÉÈôêÈóÆÈ¢ò**
   ```bash
   # ‰øÆÂ§çÊñá‰ª∂ÊùÉÈôê
   sudo chown -R castray:castray /opt/castray-system
   sudo chmod -R 755 /opt/castray-system
   ```

### 12. Êâ©Â±ïÈÖçÁΩÆ

#### Â§öRayÈõÜÁæ§ÊîØÊåÅ
Â¶ÇÊûúÈúÄË¶ÅÊîØÊåÅÂ§ö‰∏™RayÈõÜÁæ§ÔºåÂèØ‰ª•‰øÆÊîπÈÖçÁΩÆÔºö

```json
{
    "ray_clusters": [
        {
            "name": "cluster1",
            "address": "ray://192.168.1.10:10001",
            "namespace": "castray-cluster1"
        },
        {
            "name": "cluster2", 
            "address": "ray://192.168.1.20:10001",
            "namespace": "castray-cluster2"
        }
    ]
}
```

## üéØ Âø´ÈÄüÈÉ®ÁΩ≤ÊÄªÁªì

```bash
# 1. ÂáÜÂ§áÁéØÂ¢É
sudo mkdir -p /opt/castray-system && cd /opt/castray-system

# 2. ‰∏ä‰º†Êñá‰ª∂Âà∞LinuxÊúçÂä°Âô®

# 3. ÊâßË°å‰∏ÄÈîÆÈÉ®ÁΩ≤
sudo ./deploy_scripts/install.sh

# 4. ÂêØÂä®ÊúçÂä°
sudo systemctl start castray

# 5. È™åËØÅÈÉ®ÁΩ≤
curl http://localhost:8000/api/status

# 6. ËÆøÈóÆWebÁïåÈù¢
# http://your-server-ip:8000
```

ÈÉ®ÁΩ≤ÂÆåÊàêÂêéÔºåÊÇ®ÁöÑCastRayÁ≥ªÁªüÂ∞Ü‰Ωú‰∏∫RayÈõÜÁæ§ÁöÑ‰∏ÄÈÉ®ÂàÜËøêË°åÔºåÊèê‰æõÂº∫Â§ßÁöÑÂàÜÂ∏ÉÂºèÊñá‰ª∂‰º†ËæìËÉΩÂäõÔºÅ
